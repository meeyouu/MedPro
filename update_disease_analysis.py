#!/usr/bin/env python3
"""
Update all reports with comprehensive 5-disease analysis
"""
import json
from app import app, db
from models import Report

def create_comprehensive_disease_analysis():
    """Create detailed 5-disease analysis for each report"""
    
    disease_analyses = {
        1: {  # Cardiovascular patient
            "diseases": [
                {
                    "name": "بیماری عروق کرونر",
                    "probability": 88,
                    "explanation": "با توجه به سطح LDL بسیار بالا (۱۸۰ mg/dL)، HDL بحرانی پایین (۳۲ mg/dL)، و علائم درد قفسه سینه هنگام ورزش، احتمال بیماری عروق کرونر بسیار بالا است.",
                    "causes": ["سطح کلسترول LDL بالا", "HDL پایین", "فشار خون بالا", "سابقه خانوادگی بیماری قلبی", "سیگار کشیدن احتمالی"],
                    "findings": ["LDL: ۱۸۰ mg/dL (خطرناک)", "HDL: ۳۲ mg/dL (بحرانی)", "کلسترول کل: ۲۶۵ mg/dL", "درد قفسه سینه ورزشی"],
                    "recommendation": "اکوکاردیوگرافی، تست ورزش، شروع فوری استاتین دوز بالا"
                },
                {
                    "name": "آنژین صدری پایدار",
                    "probability": 82,
                    "explanation": "الگوی درد قفسه سینه که با ورزش شروع شده و با استراحت بهبود می‌یابد، نشان‌دهنده آنژین صدری کلاسیک است.",
                    "causes": ["تنگی عروق کرونر", "کاهش جریان خون به میوکارد", "افزایش نیاز اکسیژن قلب هنگام ورزش"],
                    "findings": ["درد فشاری قفسه سینه", "تشدید با ورزش", "بهبودی با استراحت", "عدم تغییرات ECG در حالت استراحت"],
                    "recommendation": "نیتروگلیسرین تحت زبانی، بتابلاکر، مراجعه به کاردیولوژیست"
                },
                {
                    "name": "سندرم متابولیک",
                    "probability": 75,
                    "explanation": "ترکیب فشار خون بالا، اختلال چربی خون، و احتمال مقاومت به انسولین نشان‌دهنده سندرم متابولیک است.",
                    "causes": ["چاقی شکمی", "مقاومت به انسولین", "فعالیت بدنی کم", "رژیم غذایی نامناسب"],
                    "findings": ["فشار خون بالا", "تری‌گلیسرید بالا: ۲۱۰ mg/dL", "HDL پایین", "کمر بزرگ احتمالی"],
                    "recommendation": "کاهش وزن، ورزش منظم، رژیم غذایی DASH، متفورمین در صورت نیاز"
                },
                {
                    "name": "هیپرلیپیدمی فامیلیال",
                    "probability": 65,
                    "explanation": "سطح بسیار بالای LDL در سن نسبتاً جوان و سابقه خانوادگی مثبت ممکن است نشان‌دهنده هیپرلیپیدمی ارثی باشد.",
                    "causes": ["جهش ژنتیکی در گیرنده LDL", "نقص در آپولیپوپروتئین B", "عوامل ارثی"],
                    "findings": ["LDL فوق‌العاده بالا", "سابقه خانوادگی مثبت", "شروع زودرس بیماری"],
                    "recommendation": "غربالگری خانواده، ژنوتایپینگ، درمان دارویی قوی"
                },
                {
                    "name": "تیروئیدیت هاشیموتو",
                    "probability": 45,
                    "explanation": "اختلال چربی خون ثانویه ممکن است به دلیل کم‌کاری تیروئید باشد که باید بررسی شود.",
                    "causes": ["کم‌کاری تیروئید", "کاهش متابولیسم", "تأثیر بر متابولیسم چربی"],
                    "findings": ["کلسترول بالا", "احتمال خستگی", "کاهش متابولیسم پایه"],
                    "recommendation": "بررسی TSH و T4، آزمایش آنتی‌بادی تیروئید"
                }
            ]
        },
        2: {  # Diabetes patient
            "diseases": [
                {
                    "name": "دیابت نوع ۲ کنترل‌نشده",
                    "probability": 95,
                    "explanation": "قند خون ناشتا ۱۸۵ mg/dL و HbA1c ۸.۲٪ نشان‌دهنده کنترل نامطلوب دیابت است.",
                    "causes": ["مقاومت به انسولین", "کاهش ترشح انسولین", "عدم رعایت رژیم دارویی", "استرس"],
                    "findings": ["قند ناشتا: ۱۸۵ mg/dL", "HbA1c: ۸.۲٪", "علائم پلی‌اوریا احتمالی"],
                    "recommendation": "تنظیم مجدد درمان، آموزش بیمار، کنترل دقیق قند"
                },
                {
                    "name": "نفروپاتی دیابتی",
                    "probability": 70,
                    "explanation": "کراتینین ۱.۴ mg/dL در بیمار دیابتی نشان‌دهنده شروع آسیب کلیوی است.",
                    "causes": ["قند خون بالای مزمن", "فشار داخل کلیوی بالا", "التهاب عروقی"],
                    "findings": ["کراتینین بالا: ۱.۴ mg/dL", "BUN بالا: ۲۸ mg/dL", "احتمال پروتئین‌اوریا"],
                    "recommendation": "آزمایش ادرار، میکروآلبومین، ACE inhibitor"
                },
                {
                    "name": "رتینوپاتی دیابتی",
                    "probability": 60,
                    "explanation": "با HbA1c بالای ۸٪، ریسک آسیب به شبکیه چشم افزایش می‌یابد.",
                    "causes": ["قند خون بالای مزمن", "آسیب عروق ریز شبکیه", "التهاب میکروواسکولار"],
                    "findings": ["کنترل نامطلوب دیابت", "مدت طولانی بیماری", "عدم معاینه چشم‌پزشکی منظم"],
                    "recommendation": "معاینه فوری چشم‌پزشکی، فوندوسکوپی، OCT"
                },
                {
                    "name": "بیماری قلبی-عروقی دیابتی",
                    "probability": 75,
                    "explanation": "دیابت عامل ریسک مهم بیماری قلبی است، خصوصاً با کنترل نامطلوب.",
                    "causes": ["آترواسکلروز تسریع‌شده", "دیسلیپیدمی دیابتی", "التهاب عروقی"],
                    "findings": ["تری‌گلیسرید بالا: ۲۸۰ mg/dL", "HDL پایین: ۳۸ mg/dL", "دیابت کنترل‌نشده"],
                    "recommendation": "اکوکاردیوگرافی، تست ورزش، استاتین، آسپرین"
                },
                {
                    "name": "نوروپاتی دیابتی",
                    "probability": 55,
                    "explanation": "با مدت طولانی دیابت و کنترل نامطلوب، ریسک آسیب عصبی وجود دارد.",
                    "causes": ["قند خون بالای مزمن", "آسیب میلین اعصاب", "التهاب عصبی"],
                    "findings": ["احتمال بی‌حسی دست‌ها", "سوزش کف پا", "کاهش رفلکس‌ها"],
                    "recommendation": "EMG/NCV، معاینه عصبی دقیق، گابا‌پنتین در صورت نیاز"
                }
            ]
        },
        4: {  # Hypothyroid patient
            "diseases": [
                {
                    "name": "هیپوتیروئیدی اولیه",
                    "probability": 98,
                    "explanation": "TSH ۱۲.۵ mIU/L و T4 پایین ۴.۲ μg/dL نشان‌دهنده کم‌کاری تیروئید آشکار است.",
                    "causes": ["تیروئیدیت هاشیموتو", "کمبود ید", "درمان‌های قبلی", "بیماری خودایمنی"],
                    "findings": ["TSH بسیار بالا", "T4 پایین", "علائم کلینیکی کم‌کاری"],
                    "recommendation": "شروع لووتیروکسین، آزمایش آنتی‌بادی"
                },
                {
                    "name": "تیروئیدیت هاشیموتو",
                    "probability": 85,
                    "explanation": "شایع‌ترین علت هیپوتیروئیدی در زنان جوان، بیماری خودایمنی است.",
                    "causes": ["خودایمنی", "عوامل ژنتیکی", "استرس", "عفونت‌های ویروسی"],
                    "findings": ["TSH بالا", "احتمال بزرگی تیروئید", "آنتی‌بادی مثبت احتمالی"],
                    "recommendation": "Anti-TPO، Anti-Tg، سونوگرافی تیروئید"
                },
                {
                    "name": "افسردگی ثانویه",
                    "probability": 70,
                    "explanation": "کم‌کاری تیروئید اغلب با علائم افسردگی همراه است.",
                    "causes": ["کاهش متابولیسم مغزی", "کمبود هورمون تیروئید", "تأثیر بر نوروترانسمیترها"],
                    "findings": ["خلق افسرده", "خستگی مزمن", "کاهش انرژی"],
                    "recommendation": "ارزیابی روانپزشکی، درمان هیپوتیروئیدی اولویت"
                },
                {
                    "name": "اختلال چربی خون ثانویه",
                    "probability": 78,
                    "explanation": "هیپوتیروئیدی معمولاً با افزایش کلسترول همراه است.",
                    "causes": ["کاهش متابولیسم چربی", "کاهش کلیرانس LDL", "کاهش فعالیت آنزیم‌ها"],
                    "findings": ["کلسترول کل بالا: ۲۴۵ mg/dL", "LDL بالا: ۱۵۵ mg/dL"],
                    "recommendation": "درمان هیپوتیروئیدی، کنترل مجدد چربی بعد از ۳ ماه"
                },
                {
                    "name": "کم‌خونی فقر آهن",
                    "probability": 45,
                    "explanation": "هیپوتیروئیدی می‌تواند با کم‌خونی همراه باشد.",
                    "causes": ["کاهش جذب آهن", "خونریزی قاعدگی زیاد", "کاهش تولید اریتروپویتین"],
                    "findings": ["احتمال خستگی بیشتر", "رنگ پریدگی", "ضعف عمومی"],
                    "recommendation": "CBC، فریتین، آهن سرم، مکمل آهن در صورت نیاز"
                }
            ]
        },
        5: {  # Chronic lung disease patient
            "diseases": [
                {
                    "name": "بیماری مزمن ریوی انسدادی (COPD)",
                    "probability": 90,
                    "explanation": "هموگلوبین و هماتوکریت بالا نشان‌دهنده پلی‌سیتمی ثانویه به هیپوکسی مزمن است.",
                    "causes": ["سیگار کشیدن طولانی‌مدت", "آلودگی هوا", "عوامل ژنتیکی", "عفونت‌های مکرر"],
                    "findings": ["هموگلوبین: ۱۶.۸ g/dL", "هماتوکریت: ۵۲٪", "تنگی نفس", "سرفه مزمن"],
                    "recommendation": "اسپیرومتری، گازهای خون شریانی، برونکودیلاتور"
                },
                {
                    "name": "پلی‌سیتمی ثانویه",
                    "probability": 95,
                    "explanation": "افزایش هموگلوبین و هماتوکریت به دلیل هیپوکسی مزمن و تحریک اریتروپویتین.",
                    "causes": ["هیپوکسی مزمن", "افزایش اریتروپویتین", "پاسخ به کمبود اکسیژن"],
                    "findings": ["هموگلوبین بالا", "هماتوکریت بالا", "احتمال سیانوز"],
                    "recommendation": "گازهای خون، اکسیژن‌تراپی، فلبوتومی در صورت نیاز"
                },
                {
                    "name": "نارسایی قلبی راست",
                    "probability": 65,
                    "explanation": "بیماری ریوی مزمن می‌تواند منجر به افزایش فشار ریوی و نارسایی قلب راست شود.",
                    "causes": ["افزایش فشار شریان ریوی", "هیپرتروفی بطن راست", "کاهش ظرفیت ورزشی"],
                    "findings": ["تنگی نفس", "ادم پاها احتمالی", "خستگی با ورزش"],
                    "recommendation": "اکوکاردیوگرافی، BNP، درمان نارسایی قلبی"
                },
                {
                    "name": "آپنه خواب",
                    "probability": 55,
                    "explanation": "COPD اغلب با آپنه خواب همراه است (Overlap Syndrome).",
                    "causes": ["انسداد راه‌های هوایی", "التهاب", "اختلال تنظیم تنفس"],
                    "findings": ["خروپف", "خواب‌آلودگی روزانه", "سردرد صبحگاهی"],
                    "recommendation": "مطالعه خواب، CPAP در صورت نیاز"
                },
                {
                    "name": "اضطراب و افسردگی",
                    "probability": 70,
                    "explanation": "بیماری‌های مزمن ریوی اغلب با اختلالات روانی همراه هستند.",
                    "causes": ["محدودیت فعالیت", "هیپوکسی", "ترس از تنگی نفس", "کیفیت زندگی پایین"],
                    "findings": ["اضطراب تنفسی", "اجتناب از فعالیت", "خلق افسرده"],
                    "recommendation": "ارزیابی روانپزشکی، تکنیک‌های تنفسی، مشاوره"
                }
            ]
        }
    }
    
    with app.app_context():
        for report_id, analysis in disease_analyses.items():
            report = Report.query.get(report_id)
            if report:
                # Update the detailed diseases field
                report.detailed_diseases = json.dumps(analysis, ensure_ascii=False)
                
                # Also update the probable_diseases field to match
                probable_diseases = {}
                for disease in analysis['diseases']:
                    probable_diseases[disease['name']] = {
                        'probability': disease['probability'],
                        'reasoning': disease['explanation']
                    }
                report.probable_diseases = json.dumps(probable_diseases, ensure_ascii=False)
                
                print(f"Updated report {report_id} with 5 comprehensive diseases")
        
        db.session.commit()
        print("All reports updated with comprehensive disease analysis")

if __name__ == "__main__":
    create_comprehensive_disease_analysis()